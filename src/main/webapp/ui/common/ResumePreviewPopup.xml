<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:w2="http://www.inswave.com/websquare"
    xmlns:xf="http://www.w3.org/2002/xforms">
    
    <head meta_screenName="이력서 PDF 미리보기 팝업">
        <w2:type>COMPONENT</w2:type>
        <w2:buildDate />
        <w2:MSA />
        <xf:model>
            <w2:dataCollection baseNode="map">
                <!-- 이력서 정보 -->
                <w2:dataMap baseNode="map" id="dma_resumeInfo">
                    <w2:keyInfo>
                        <w2:key id="result" name="결과" dataType="text"></w2:key>
                        <w2:key id="hasResume" name="이력서 존재 여부" dataType="boolean"></w2:key>
                        <w2:key id="resumeFileName" name="이력서 파일명" dataType="text"></w2:key>
                        <w2:key id="displayName" name="표시 파일명" dataType="text"></w2:key>
                        <w2:key id="viewUrl" name="조회 URL" dataType="text"></w2:key>
                        <w2:key id="message" name="메시지" dataType="text"></w2:key>
                        <w2:key id="accountId" name="계정 ID" dataType="text"></w2:key>
                        <w2:key id="userName" name="사용자명" dataType="text"></w2:key>
                    </w2:keyInfo>
                </w2:dataMap>
            </w2:dataCollection>
            
            <!-- 이력서 정보 조회 submission -->
            <xf:submission id="sbm_getResumeInfo" action="/InsWebApp/USGetResumeInfo.pwkjson" method="get" mediatype="application/json"
                ref="" target="" encoding="UTF-8" instance="" replace="" errorHandler=""
                customHandler="" mode="asynchronous" processMsg="이력서 정보 조회중" ev:submitdone="scwin.sbm_getResumeInfo_submitdone" ev:submiterror="scwin.sbm_getResumeInfo_submiterror" abortTrigger="">
            </xf:submission>
        </xf:model>
        
        <style type="text/css"><![CDATA[
            /* 팝업 컨테이너 */
            .popup-container {
                display: flex;
                flex-direction: column;
                height: 100%;
                background-color: #fff;
                border-radius: 8px;
                overflow: hidden;
            }
            
            /* 헤더 영역 */
            .popup-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 20px;
                background-color: #f8f9fa;
                border-bottom: 1px solid #e9ecef;
            }
            
            .popup-title {
                font-size: 16px;
                font-weight: bold;
                color: #333;
                margin: 0;
                flex: 1;
            }
            
            .popup-buttons {
                display: flex;
                gap: 8px;
            }
            
            .popup-btn {
                padding: 6px 12px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                font-weight: 500;
                transition: background-color 0.2s;
            }
            
            .popup-btn.btn-new-window {
                background-color: #007bff;
                color: white;
            }
            
            .popup-btn.btn-new-window:hover {
                background-color: #0056b3;
            }
            
            .popup-btn.btn-new-tab {
                background-color: #28a745;
                color: white;
            }
            
            .popup-btn.btn-new-tab:hover {
                background-color: #1e7e34;
            }
            
            .popup-btn.btn-close {
                background-color: #6c757d;
                color: white;
            }
            
            .popup-btn.btn-close:hover {
                background-color: #545b62;
            }
            
            /* PDF 뷰어 영역 */
            .pdf-viewer-area {
                flex: 1;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                background-color: #f8f9fa;
            }
            
            .pdf-iframe {
                width: 100%;
                height: 100%;
                border: 1px solid #ddd;
                border-radius: 4px;
                background-color: white;
            }
            
            /* 메시지 영역 */
            .message-area {
                text-align: center;
                padding: 40px 20px;
                color: #6c757d;
            }
            
            .message-title {
                font-size: 18px;
                font-weight: bold;
                margin-bottom: 10px;
                color: #495057;
            }
            
            .message-text {
                font-size: 14px;
                line-height: 1.5;
            }
            
            /* 로딩 스피너 */
            .loading-spinner {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid #007bff;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-right: 8px;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        ]]></style>
        
        <script lazy="false" type="text/javascript"><![CDATA[
            // 팝업 로드 시 실행
            scwin.onpageload = function() {
                console.log("이력서 미리보기 팝업 로드");
                
                // 부모로부터 전달받은 파라미터 확인
                var paramData = null;
                try {
                    // 여러 방법으로 파라미터 가져오기 시도
                    if ($p.getParameter && typeof $p.getParameter === 'function') {
                        paramData = $p.getParameter("paramData");
                    } 
                    
                    if (!paramData && $c.data && $c.data.getParameter) {
                        paramData = $c.data.getParameter("paramData");
                    }
                    
                    // 부모 윈도우에서 직접 가져오기
                    if (!paramData && opener && opener.scwin && opener.scwin.paramData) {
                        paramData = opener.scwin.paramData;
                    }

                    // 세션 스토리지에서 가져오기
                    if (!paramData) {
                        var sessionData = sessionStorage.getItem("resumePreviewParams");
                        if (sessionData) {
                            try {
                                paramData = JSON.parse(sessionData);
                            } catch (e) {
                                console.error("세션 데이터 파싱 오류:", e);
                            }
                        }
                    }
                } catch (e) {
                    console.error("파라미터 가져오기 오류:", e);
                }
                
                console.log("전달받은 파라미터:", paramData);
                
                if (paramData) {
                    var accountId = paramData.accountId;
                    var userName = paramData.userName || "사용자";
                    var resumeFileName = paramData.resumeFileName;
                    
                    if (accountId) {
                        // 데이터맵에 기본 정보 설정
                        dma_resumeInfo.set("accountId", accountId);
                        dma_resumeInfo.set("userName", userName);
                        dma_resumeInfo.set("resumeFileName", resumeFileName);
                        
                        // 팝업 타이틀 설정
                        popup_title.setValue(userName + "의 이력서");
                        
                        // 이력서 정보 조회
                        scwin.loadResumeInfo(accountId);
                    } else {
                        scwin.showMessage("오류", "사용자 정보가 올바르지 않습니다.");
                    }
                } else {
                    scwin.showMessage("오류", "전달받은 파라미터가 없습니다.");
                }
            };
            
            // 이력서 정보 조회
            scwin.loadResumeInfo = function(userId) {
                console.log("이력서 정보 조회 시작 - 사용자 ID:", userId);
                
                // API URL 설정
                var apiUrl = "/InsWebApp/USGetResumeInfo.pwkjson?userId=" + userId;
                console.log("API URL:", apiUrl);
                
                // resumeFileName이 이미 있는 경우 그것을 바로 사용
                var resumeFileName = dma_resumeInfo.get("resumeFileName");
                if (resumeFileName) {
                    console.log("이미 가지고 있는 이력서 파일명을 사용:", resumeFileName);
                    
                    // 이미 가지고 있는 파일명으로 바로 처리
                    var mockResponse = {
                        result: "success",
                        hasResume: true,
                        resumeFileName: resumeFileName,
                        displayName: "이력서.pdf"
                    };
                    
                    // 뷰어 바로 호출
                    scwin.showPdfViewer(mockResponse);
                    return;
                }
                
                sbm_getResumeInfo.action = apiUrl;
                
                // 로딩 표시
                scwin.showLoading();
                
                // API 호출
                $c.sbm.execute($p, sbm_getResumeInfo);
            };
            
            // 이력서 정보 조회 완료
            scwin.sbm_getResumeInfo_submitdone = function(e) {
                console.log("이력서 정보 조회 완료", e);
                
                try {
                    if (!e || !e.responseJSON) {
                        scwin.showMessage("오류", "서버 응답 데이터가 없습니다.");
                        return;
                    }
                    
                    var responseData = e.responseJSON;
                    console.log("이력서 정보 응답:", responseData);
                    
                    // 데이터맵에 설정
                    var keysToSet = ["result", "hasResume", "resumeFileName", "displayName", "viewUrl", "message"];
                    for (var i = 0; i < keysToSet.length; i++) {
                        var key = keysToSet[i];
                        if (responseData.hasOwnProperty(key)) {
                            dma_resumeInfo.set(key, responseData[key]);
                        }
                    }
                    
                    // 이력서 존재 여부에 따른 처리
                    if (responseData.result === "success" && (responseData.hasResume === true || responseData.resumeFileName)) {
                        scwin.showPdfViewer(responseData);
                    } else {
                        var message = responseData.message || "등록된 이력서가 없습니다.";
                        scwin.showMessage("이력서 없음", message);
                    }
                } catch (err) {
                    console.error("이력서 정보 처리 중 오류:", err);
                    scwin.showMessage("오류", "이력서 정보 처리 중 오류가 발생했습니다: " + err.message);
                }
            };
            
            // 이력서 정보 조회 오류
            scwin.sbm_getResumeInfo_submiterror = function(e) {
                console.error("이력서 정보 조회 오류", e);
                
                var errorMessage = "이력서 정보 조회 중 오류가 발생했습니다.";
                
                if (e.status === 404) {
                    errorMessage = "이력서 정보를 찾을 수 없습니다.";
                } else if (e.status === 500) {
                    errorMessage = "서버 내부 오류가 발생했습니다.";
                }
                
                scwin.showMessage("오류", errorMessage);
            };
            
            // PDF 뷰어 표시
            scwin.showPdfViewer = function(resumeData) {
                console.log("PDF 뷰어 표시", resumeData);
                
                var viewUrl = resumeData.viewUrl;
                var resumeFileName = resumeData.resumeFileName;
                
                try {
                    // URL 생성
                    if (!viewUrl && resumeFileName) {
                        // 직접 PDF 파일 경로로 접근
                        if (resumeFileName.toLowerCase().endsWith('.pdf')) {
                            // 파일명이 직접 PDF 경로인 경우
                            if (resumeFileName.startsWith('/')) {
                                // 이미 / 로 시작하는 경우
                                viewUrl = "/InsWebApp/USViewResume.pwkjson?filePath=" + encodeURIComponent(resumeFileName);
                            } else {
                                // / 로 시작하지 않는 경우
                                viewUrl = "/InsWebApp/USViewResume.pwkjson?filePath=/" + encodeURIComponent(resumeFileName);
                            }
                        } else {
                            // API를 통해 접근
                            viewUrl = "/InsWebApp/USViewResume.pwkjson?filePath=" + encodeURIComponent(resumeFileName);
                        }
                    }
                    
                    if (!viewUrl) {
                        // 여전히 URL이 없는 경우, userId를 사용해서 파일 경로 생성 시도
                        var accountId = dma_resumeInfo.get("accountId");
                        if (accountId) {
                            viewUrl = "/InsWebApp/USViewResume.pwkjson?userId=" + accountId;
                        }
                    }
                    
                    if (!viewUrl) {
                        scwin.showMessage("오류", "PDF 파일 URL을 생성할 수 없습니다.");
                        return;
                    }
                    
                    if (!viewUrl.startsWith("http") && !viewUrl.startsWith("/")) {
                        viewUrl = "/" + viewUrl;
                    }
                    
                    if (!viewUrl.startsWith("/InsWebApp/") && !viewUrl.startsWith("http")) {
                        viewUrl = "/InsWebApp" + viewUrl;
                    }
                    
                    // 현재 페이지의 기본 URL
                    var baseUrl = window.location.protocol + "//" + window.location.host;
                    var fullUrl = viewUrl.startsWith("http") ? viewUrl : baseUrl + viewUrl;
                    
                    console.log("PDF 뷰어 URL:", fullUrl);
                    
                    // iframe에 설정
                    ifm_pdfViewer.setSrc(fullUrl);
                    
                    // PDF 뷰어 영역 표시
                    pdf_viewer_area.show();
                    message_area.hide();
                } catch (error) {
                    console.error("PDF 뷰어 표시 중 오류:", error);
                    scwin.showMessage("오류", "PDF 파일을 표시하는 중 오류가 발생했습니다: " + error.message);
                }
            };
            
            // 메시지 표시
            scwin.showMessage = function(title, message) {
                console.log("메시지 표시:", title, message);
                
                message_title.setValue(title);
                message_text.setValue(message);
                
                message_area.show();
                pdf_viewer_area.hide();
            };
            
            // 로딩 표시
            scwin.showLoading = function() {
                message_title.setValue("로딩중...");
                message_text.setValue("이력서 정보를 가져오는 중입니다.");
                
                message_area.show();
                pdf_viewer_area.hide();
            };
            
            // 새 창에서 열기
            scwin.btn_newWindow_onclick = function() {
                try {
                    var viewUrl = dma_resumeInfo.get("viewUrl");
                    var resumeFileName = dma_resumeInfo.get("resumeFileName");
                    var accountId = dma_resumeInfo.get("accountId");
                    
                    if (!viewUrl && resumeFileName) {
                        // URL 생성 로직 재활용
                        if (resumeFileName.toLowerCase().endsWith('.pdf')) {
                            if (resumeFileName.startsWith('/')) {
                                viewUrl = "/InsWebApp/USViewResume.pwkjson?filePath=" + encodeURIComponent(resumeFileName);
                            } else {
                                viewUrl = "/InsWebApp/USViewResume.pwkjson?filePath=/" + encodeURIComponent(resumeFileName);
                            }
                        } else {
                            viewUrl = "/InsWebApp/USViewResume.pwkjson?filePath=" + encodeURIComponent(resumeFileName);
                        }
                    }
                    
                    if (!viewUrl && accountId) {
                        viewUrl = "/InsWebApp/USViewResume.pwkjson?userId=" + accountId;
                    }
                    
                    if (!viewUrl) {
                        $c.win.alert("PDF 파일 URL을 생성할 수 없습니다.");
                        return;
                    }
                    
                    if (!viewUrl.startsWith("http") && !viewUrl.startsWith("/")) {
                        viewUrl = "/" + viewUrl;
                    }
                    
                    if (!viewUrl.startsWith("/InsWebApp/") && !viewUrl.startsWith("http")) {
                        viewUrl = "/InsWebApp" + viewUrl;
                    }
                    
                    var baseUrl = window.location.protocol + "//" + window.location.host;
                    var fullUrl = viewUrl.startsWith("http") ? viewUrl : baseUrl + viewUrl;
                    
                    // 새 창으로 열기
                    window.open(fullUrl, "_blank", "width=800,height=600,scrollbars=yes,resizable=yes");
                } catch (error) {
                    console.error("새 창에서 PDF 열기 중 오류:", error);
                    $c.win.alert("새 창에서 PDF를 열 수 없습니다: " + error.message);
                }
            };
            
            // 새 탭에서 열기
            scwin.btn_newTab_onclick = function() {
                try {
                    var viewUrl = dma_resumeInfo.get("viewUrl");
                    var resumeFileName = dma_resumeInfo.get("resumeFileName");
                    var accountId = dma_resumeInfo.get("accountId");
                    
                    if (!viewUrl && resumeFileName) {
                        // URL 생성 로직 재활용
                        if (resumeFileName.toLowerCase().endsWith('.pdf')) {
                            if (resumeFileName.startsWith('/')) {
                                viewUrl = "/InsWebApp/USViewResume.pwkjson?filePath=" + encodeURIComponent(resumeFileName);
                            } else {
                                viewUrl = "/InsWebApp/USViewResume.pwkjson?filePath=/" + encodeURIComponent(resumeFileName);
                            }
                        } else {
                            viewUrl = "/InsWebApp/USViewResume.pwkjson?filePath=" + encodeURIComponent(resumeFileName);
                        }
                    }
                    
                    if (!viewUrl && accountId) {
                        viewUrl = "/InsWebApp/USViewResume.pwkjson?userId=" + accountId;
                    }
                    
                    if (!viewUrl) {
                        $c.win.alert("PDF 파일 URL을 생성할 수 없습니다.");
                        return;
                    }
                    
                    if (!viewUrl.startsWith("http") && !viewUrl.startsWith("/")) {
                        viewUrl = "/" + viewUrl;
                    }
                    
                    if (!viewUrl.startsWith("/InsWebApp/") && !viewUrl.startsWith("http")) {
                        viewUrl = "/InsWebApp" + viewUrl;
                    }
                    
                    var baseUrl = window.location.protocol + "//" + window.location.host;
                    var fullUrl = viewUrl.startsWith("http") ? viewUrl : baseUrl + viewUrl;
                    
                    // 새 탭으로 열기
                    window.open(fullUrl, "_blank");
                } catch (error) {
                    console.error("새 탭에서 PDF 열기 중 오류:", error);
                    $c.win.alert("새 탭에서 PDF를 열 수 없습니다: " + error.message);
                }
            };
            
            // 팝업 닫기
            scwin.btn_close_onclick = function() {
                $c.win.closePopup();
            };
        ]]></script>
    </head>
    
    <body ev:onpageload="scwin.onpageload">
        <xf:group class="popup-container">
            <!-- 헤더 영역 -->
            <xf:group class="popup-header">
                <w2:textbox id="popup_title" class="popup-title" label="이력서 미리보기"></w2:textbox>
                <xf:group class="popup-buttons">
                    <xf:trigger id="btn_newWindow" class="popup-btn btn-new-window" type="button" ev:onclick="scwin.btn_newWindow_onclick">
                        <xf:label>새창에서 열기</xf:label>
                    </xf:trigger>
                    <xf:trigger id="btn_newTab" class="popup-btn btn-new-tab" type="button" ev:onclick="scwin.btn_newTab_onclick">
                        <xf:label>새탭에서 열기</xf:label>
                    </xf:trigger>
                    <xf:trigger id="btn_close" class="popup-btn btn-close" type="button" ev:onclick="scwin.btn_close_onclick">
                        <xf:label>닫기</xf:label>
                    </xf:trigger>
                </xf:group>
            </xf:group>
            
            <!-- PDF 뷰어 영역 -->
            <xf:group id="pdf_viewer_area" class="pdf-viewer-area" style="display:none;">
                <w2:iframe id="ifm_pdfViewer" class="pdf-iframe" src=""></w2:iframe>
            </xf:group>
            
            <!-- 메시지 영역 -->
            <xf:group id="message_area" class="message-area">
                <w2:textbox id="message_title" class="message-title" label="로딩중..."></w2:textbox>
                <w2:textbox id="message_text" class="message-text" label="이력서 정보를 가져오는 중입니다."></w2:textbox>
            </xf:group>
        </xf:group>
    </body>
</html> 