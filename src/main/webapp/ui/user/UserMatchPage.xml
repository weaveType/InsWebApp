<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:w2="http://www.inswave.com/websquare" 
    xmlns:xf="http://www.w3.org/2002/xforms">
    
    <head meta_screenName="매칭제안">
        <w2:type>COMPONENT</w2:type>
        <w2:buildDate/>
        <w2:MSA/>
        <xf:model>
            <w2:dataCollection baseNode="map">
            	<w2:dataList baseNode="list" repeatNode="map" id="dlt_matchOffers" saveRemovedData="true">
            		<w2:columnInfo>
            			<w2:column id="company" name="회사명" dataType="text"></w2:column>
            			<w2:column id="jobTitle" name="공고제목" dataType="text"></w2:column>
            			<w2:column id="position" name="포지션" dataType="text"></w2:column>
            			<w2:column id="location" name="근무지역" dataType="text"></w2:column>
            			<w2:column id="salary" name="연봉" dataType="text"></w2:column>
            			<w2:column id="experience" name="경력" dataType="text"></w2:column>
            			<w2:column id="status" name="상태" dataType="text"></w2:column>
            			<w2:column id="logo" name="로고" dataType="text"></w2:column>
            			<w2:column id="jobPostingId" name="공고ID" dataType="text"></w2:column>
            			<w2:column id="companyId" name="회사ID" dataType="text"></w2:column>
            		</w2:columnInfo>
            	</w2:dataList>
            	<w2:dataMap baseNode="map" id="dataMap1">
            		<w2:keyInfo></w2:keyInfo>
            	</w2:dataMap>
            </w2:dataCollection>
        </xf:model>
        <w2:layoutInfo/>
        <w2:publicInfo method=""/>
        
        <style type="text/css"><![CDATA[

        ]]></style>
        
        <script lazy="false" type="text/javascript"><![CDATA[
scwin.onpageload = function() {
    // 페이지 로드 시 통계 계산 및 카드 렌더링
    scwin.calculateStats();
    scwin.applyStatusClasses();
    scwin.setupFilterTabs();
};

// 통계 계산
scwin.calculateStats = function() {
    var totalCount = dlt_matchOffers.getRowCount();
    var newCount = 0;
    var viewedCount = 0;
    var interestedCount = 0;
    
    for (var i = 0; i < totalCount; i++) {
        var status = dlt_matchOffers.getCellData(i, "status");
        if (status === "NEW") {
            newCount++;
        } else if (status === "VIEWED") {
            viewedCount++;
        } else if (status === "INTERESTED") {
            interestedCount++;
        }
    }
    
    // 통계 표시
    setTimeout(function() {
        var totalElement = document.getElementById('totalMatches');
        var newElement = document.getElementById('newMatches');
        var viewedElement = document.getElementById('viewedMatches');
        var interestedElement = document.getElementById('interestedMatches');
        
        if (totalElement) totalElement.textContent = totalCount;
        if (newElement) newElement.textContent = newCount;
        if (viewedElement) viewedElement.textContent = viewedCount;
        if (interestedElement) interestedElement.textContent = interestedCount;
    }, 100);
};

// 상태별 클래스 적용
scwin.applyStatusClasses = function() {
    var totalCount = dlt_matchOffers.getRowCount();
    
    setTimeout(function() {
        var cards = document.querySelectorAll('.match-card');
        var statusBadges = document.querySelectorAll('.status-badge');
        
        for (var i = 0; i < cards.length && i < totalCount; i++) {
            var status = dlt_matchOffers.getCellData(i, "status");
            var card = cards[i];
            var badge = statusBadges[i];
            
            // 카드 클래스 적용
            if (status === "NEW") {
                card.classList.add('new');
                if (badge) {
                    badge.className = 'status-badge status-new';
                    badge.textContent = 'NEW';
                }
            } else if (status === "VIEWED") {
                card.classList.add('viewed');
                if (badge) {
                    badge.className = 'status-badge status-viewed';
                    badge.textContent = '확인함';
                }
            } else if (status === "INTERESTED") {
                card.classList.add('interested');
                if (badge) {
                    badge.className = 'status-badge status-interested';
                    badge.textContent = '관심표시';
                }
            }
        }
    }, 100);
};

// 필터 탭 설정
scwin.setupFilterTabs = function() {
    setTimeout(function() {
        var tabs = document.querySelectorAll('.filter-tab');
        if (tabs.length > 0) {
            tabs[0].classList.add('active');
        }
    }, 100);
};

// 필터링
scwin.filterMatches = function(type) {
    // 모든 탭에서 active 클래스 제거
    var tabs = document.querySelectorAll('.filter-tab');
    tabs.forEach(function(tab) {
        tab.classList.remove('active');
    });
    
    // 클릭된 탭에 active 클래스 추가
    event.target.classList.add('active');
    
    // 카드 필터링
    var cards = document.querySelectorAll('.match-card');
    var totalCount = dlt_matchOffers.getRowCount();
    
    for (var i = 0; i < cards.length && i < totalCount; i++) {
        var card = cards[i];
        var status = dlt_matchOffers.getCellData(i, "status");
        var shouldShow = false;
        
        switch(type) {
            case 'all':
                shouldShow = true;
                break;
            case 'new':
                shouldShow = (status === "NEW");
                break;
            case 'viewed':
                shouldShow = (status === "VIEWED");
                break;
            case 'interested':
                shouldShow = (status === "INTERESTED");
                break;
        }
        
        card.style.display = shouldShow ? 'block' : 'none';
    }
};

// 매칭제안 상세보기
scwin.viewMatchDetail = function(rowIndex) {
    var company = dlt_matchOffers.getCellData(rowIndex, "company");
    var jobTitle = dlt_matchOffers.getCellData(rowIndex, "jobTitle");
    var position = dlt_matchOffers.getCellData(rowIndex, "position");
    var location = dlt_matchOffers.getCellData(rowIndex, "location");
    var salary = dlt_matchOffers.getCellData(rowIndex, "salary");
    var experience = dlt_matchOffers.getCellData(rowIndex, "experience");
    var postId = dlt_matchOffers.getCellData(rowIndex, "postId");
    
    // 상태를 VIEWED로 변경
    dlt_matchOffers.setCellData(rowIndex, "status", "VIEWED");
    
    // 공고 상세 페이지로 이동 (실제로는 해당 페이지로 이동)
    var detailMessage = "=== 매칭 제안 상세 정보 ===\n\n";
    detailMessage += "회사명: " + company + "\n";
    detailMessage += "공고제목: " + jobTitle + "\n";
    detailMessage += "포지션: " + position + "\n";
    detailMessage += "근무지역: " + location + "\n";
    detailMessage += "연봉: " + salary + "\n";
    detailMessage += "경력: " + experience + "\n";
    detailMessage += "\n해당 공고 페이지로 이동합니다.";
    
    alert(detailMessage);
    
    // 통계 재계산 및 UI 업데이트
    scwin.calculateStats();
    scwin.applyStatusClasses();
};

// 지원하기
scwin.applyToJob = function(rowIndex) {
    var company = dlt_matchOffers.getCellData(rowIndex, "company");
    var jobTitle = dlt_matchOffers.getCellData(rowIndex, "jobTitle");
    var postId = dlt_matchOffers.getCellData(rowIndex, "postId");
    
    // 상태를 INTERESTED로 변경
    dlt_matchOffers.setCellData(rowIndex, "status", "INTERESTED");
    
    var confirmMessage = company + "의 '" + jobTitle + "' 포지션에 지원하시겠습니까?";
    
    if (confirm(confirmMessage)) {
        alert("지원이 완료되었습니다!");
        
        // 통계 재계산 및 UI 업데이트
        scwin.calculateStats();
        scwin.applyStatusClasses();
        
        // 실제로는 지원 API 호출
    }
};

// 매칭제안 카드 클릭 시 상세보기
scwin.onMatchCardClick = function(rowIndex) {
    scwin.viewMatchDetail(rowIndex);
};

// 검색 기능
scwin.searchMatches = function(searchText) {
    if (!searchText || searchText.trim() === "") {
        scwin.filterMatches('all');
        return;
    }
    
    var cards = document.querySelectorAll('.match-card');
    var totalCount = dlt_matchOffers.getRowCount();
    
    for (var i = 0; i < cards.length && i < totalCount; i++) {
        var card = cards[i];
        var company = dlt_matchOffers.getCellData(i, "company");
        var jobTitle = dlt_matchOffers.getCellData(i, "jobTitle");
        var position = dlt_matchOffers.getCellData(i, "position");
        
        var shouldShow = company.toLowerCase().includes(searchText.toLowerCase()) || 
                        jobTitle.toLowerCase().includes(searchText.toLowerCase()) ||
                        position.toLowerCase().includes(searchText.toLowerCase());
        
        card.style.display = shouldShow ? 'block' : 'none';
    }
};

// 데이터 새로고침
scwin.refreshData = function() {
    // 실제 환경에서는 서버에서 데이터를 다시 가져오는 로직
    scwin.calculateStats();
    scwin.applyStatusClasses();
    alert("새로운 매칭제안을 확인했습니다.");
};
]]></script>
    </head>
    
    <body ev:onpageload="scwin.onpageload">
        <xf:group class="main-wrap">

            <!-- 메인 컨테이너 -->
            <xf:group class="main-container">
                <!-- 메인 콘텐츠 -->
                <main class="main-content">
                    <!-- 매칭제안 페이지 헤더 -->
                    <section class="page-header">
                        <div class="page-info">                          <div class="page-details">
                                <h1>매칭 제안</h1>
                                <div class="page-description">기업에서 보낸 매칭 제안을 확인하고 관심있는 공고에 지원해보세요.</div>
                            </div>
                        </div>
                    </section>

                    <!-- 매칭제안 통계 -->
                    <section class="stats-grid">
                    </section>

                    <!-- 필터 탭 -->
                    <section class="filter-section">
                    </section>

                    <!-- 매칭제안 카드들 -->
                    <section class="matches-section">
                        <div class="matches-grid">
                            <w2:generator id="gen_matches" dataList="data:dlt_matchOffers" style="">
                                <div class="match-card" onclick="scwin.onMatchCardClick(%%_rowIndex%%)">
                                    <div class="status-badge"></div>
                                    
                                    <div class="card-header">
                                        <div class="company-info">
                                            <div class="company-logo">
                                                <w2:textbox ref="data:dlt_matchOffers.logo"></w2:textbox>
                                            </div>
                                            <div class="company-details">
                                                <div class="company-name">
                                                    <w2:textbox ref="data:dlt_matchOffers.company"></w2:textbox>
                                                </div>
                                                <div class="job-title">
                                                    <w2:textbox ref="data:dlt_matchOffers.jobTitle"></w2:textbox>
                                                </div>
                                                <div class="position-name">
                                                    <w2:textbox ref="data:dlt_matchOffers.position"></w2:textbox>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card-body">
                                        <div class="info-item">
                                            <div class="info-value">
                                                <w2:textbox ref="data:dlt_matchOffers.location"></w2:textbox>
                                            </div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-value">
                                                <w2:textbox ref="data:dlt_matchOffers.salary"></w2:textbox>
                                            </div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-value">
                                                <w2:textbox ref="data:dlt_matchOffers.experience"></w2:textbox>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </w2:generator>
                        </div>
                    </section>
                </main>
            </xf:group>
        </xf:group>
    </body>
</html>
