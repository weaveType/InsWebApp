<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" 
      xmlns:ev="http://www.w3.org/2001/xml-events" 
      xmlns:w2="http://www.inswave.com/websquare" 
      xmlns:xf="http://www.w3.org/2002/xforms">
        
    <head>
        <w2:type>COMPONENT</w2:type>
        <w2:buildDate/>
        <w2:MSA/>
        
        <xf:model>
            <w2:dataCollection baseNode="map">
                <!-- 로그인 정보를 담을 데이터맵 -->
                <w2:dataMap baseNode="map" id="dmp_loginVo">
                    <w2:keyInfo>
                        <w2:key dataType="text" name="이메일" id="email"></w2:key>
                        <w2:key dataType="text" name="비밀번호" id="password"></w2:key>
                    </w2:keyInfo>
                </w2:dataMap>
            </w2:dataCollection>
            
            <w2:workflowCollection/>
            
            <!-- 로그인 처리 submission -->
            <xf:submission id="sbm_login" 
                          action="/InsWebApp/USLogin.pwkjson" 
                          method="post" 
                          mediatype="application/json"
                          ref='data:json,["dmp_loginVo",{"id":"dmp_loginVo","key":"loginVo"}]' 
                          target="" 
                          encoding="UTF-8" 
                          instance="" 
                          replace="" 
                          errorHandler="" 
                          customHandler="" 
                          mode="asynchronous" 
                          processMsg="로그인 중입니다..." 
                          ev:submit=""
                          ev:submitdone="scwin.sbm_login_submitdone" 
                          ev:submiterror="scwin.sbm_login_submiterror" 
                          abortTrigger="">
            </xf:submission>
        </xf:model>
        
        <w2:layoutInfo/>
        <w2:publicInfo method=""/>
        
        <script lazy="false" type="text/javascript"><![CDATA[
// 페이지 로드 이벤트
scwin.onpageload = function () {
    // 저장된 이메일이 있으면 로드
    scwin.loadRememberedEmail();
};

// 회원가입 페이지로 이동
scwin.lnk_create_corporate_onclick = function () {
    try {
        // 부모 페이지의 pf_main 컴포넌트에 직접 접근
        if ($p.parent().pf_main) {
            $p.parent().pf_main.setSrc("../corporate/CreateCompany.xml");
        } else {
            console.warn("부모 페이지에 pf_main이 없습니다.");
            $p.url("../corporate/CreateCompany.xml");
        }
    } catch (e) {
        console.error("페이지 이동 중 오류:", e);
        $p.url("../corporate/CorporateLogin.xml");
    }
};

// 로그인 버튼 클릭 이벤트
scwin.btn_login_onclick = function () {
    try {
        $c.sbm.execute(sbm_login);

    } catch (error) {
        console.error("로그인 처리 중 오류:", error);
        scwin.showErrorMessage("로그인 처리 중 오류가 발생했습니다.");
    }
};

// 폼 검증 함수
scwin.validateLoginForm = function () {
    return true;
};

// 로그인 성공 처리
scwin.sbm_login_submitdone = function (e) {
    // WebSquare 응답 구조에 맞게 수정
    var elHeader = e.responseJSON.elHeader;
    var userHeader = e.responseJSON.userHeader;

    // 성공 여부 체크: elHeader.resSuc 사용
    if (elHeader && elHeader.resSuc === true) {
        var role = userHeader.role;
        try {
            if (role === "COMPANY") {
                // 부모 페이지에 사용자 정보 저장
                if ($p.parent().scwin && $p.parent().scwin.setUserInfo) {
                    $p.parent().scwin.setUserInfo(userHeader);
                }
                
                if ($p.parent().pf_main) {
                    $p.parent().pf_main.setSrc("../corporate/RecruitmentDashboard.xml");
                } else {
                    console.warn("부모 페이지에 pf_main이 없습니다.");
                    $p.url("../corporate/RecruitmentDashboard.xml");
                }
            } else {
                alert("기업 회원이 아닙니다. 재가입 해주세요");
            }
        } catch (e) {
            console.error("페이지 이동 중 오류:", e);
            $p.url("../corporate/CorporateLogin.xml");
        }
    } else {
        // 로그인 실패
        var message = (elHeader && elHeader.resMsg) || "로그인에 실패했습니다. 아이디와 비밀번호를 확인해주세요.";
        alert(message);

        // 비밀번호 필드 초기화
        inp_userPw.setValue("");
        inp_userPw.focus();
    }
};

// 에러 메시지 표시
scwin.showErrorMessage = function (message) {
    txt_errorMessage.setValue(message);
    grp_errorMessage.style.display = "block";
};

// 에러 메시지 숨기기
scwin.hideErrorMessage = function () {
    grp_errorMessage.style.display = "none";
};

// 성공 메시지 표시
scwin.showSuccessMessage = function (message) {
    txt_successMessage.setValue(message);
    grp_successMessage.style.display = "block";

    // 3초 후 자동으로 숨기기
    setTimeout(function () {
        grp_successMessage.style.display = "none";
    }, 3000);
};

// 이메일 저장 (자동로그인)
scwin.saveRememberedEmail = function (email) {
    try {
        if (typeof (Storage) !== "undefined") {
            localStorage.setItem("rememberedEmail", email);
        }
    } catch (error) {
        console.warn("이메일 저장 실패:", error);
    }
};

// 저장된 이메일 로드
scwin.loadRememberedEmail = function () {
    try {
        if (typeof (Storage) !== "undefined") {
            var savedEmail = localStorage.getItem("rememberedEmail");
            if (savedEmail) {
                dmp_loginVo.set("email", savedEmail);
                dmp_loginVo.set("rememberMe", "Y");
            }
        }
    } catch (error) {
        console.warn("저장된 이메일 로드 실패:", error);
    }
};

// 저장된 이메일 삭제
scwin.clearRememberedEmail = function () {
    try {
        if (typeof (Storage) !== "undefined") {
            localStorage.removeItem("rememberedEmail");
        }
    } catch (error) {
        console.warn("저장된 이메일 삭제 실패:", error);
    }
};

// 비밀번호 표시/숨기기 토글
scwin.btn_toggle_password_onclick = function () {
    var passwordInput = inp_password;
    if (passwordInput.getAttribute("type") === "password") {
        passwordInput.setAttribute("type", "text");
        lnk_toggle_password.setValue("비밀번호 숨기기");
    } else {
        passwordInput.setAttribute("type", "password");
        lnk_toggle_password.setValue("비밀번호 보기");
    }
};

// Enter 키 이벤트 처리
scwin.inp_email_onkeypress = function (e) {
    if (e.keyCode === 13) { // Enter 키
        inp_password.focus();
    }
};

scwin.inp_password_onkeypress = function (e) {
    if (e.keyCode === 13) { // Enter 키
        scwin.btn_login_onclick();
    }
};
]]></script>
            
    </head>
        
    <body class="" ev:onpageload="scwin.onpageload">
        
        <xf:group class="login_wrap" id="" style="">
            
            <xf:group class="login_logo" id="" tagname="h1">
                <w2:anchor id="" outerDiv="false" style="" title="Inswave">
                    <xf:label/>
                </w2:anchor>
            </xf:group>
            
            <xf:group class="login_container" id="">
                
                <xf:group class="login_header" id="">
                    <w2:textbox id="" label="WELCOME" style=""/>
                    <w2:textbox class="login_info" id="" label="SIGN IN TO INSWAVE" style=""/>
                </xf:group>
                
                <!-- 에러 메시지 영역 -->
                <xf:group id="grp_errorMessage" style="display:none; background-color:#ffebee; border:1px solid #f44336; padding:10px; margin:10px 0; border-radius:4px;">
                    <w2:textbox id="txt_errorMessage" style="color:#c62828; font-size:14px;"/>
                </xf:group>
                
                <!-- 성공 메시지 영역 -->
                <xf:group id="grp_successMessage" style="display:none; background-color:#e8f5e8; border:1px solid:#4caf50; padding:10px; margin:10px 0; border-radius:4px;">
                    <w2:textbox id="txt_successMessage" style="color:#2e7d32; font-size:14px;"/>
                </xf:group>
                
                <xf:group class="login_contents" id="" style="">
                    
                    <xf:group id="" tagname="ul">
                        
                        <xf:group id="" tagname="li">
                            <w2:textbox class="tit" for="inp_email" id="" label="Email" style="" tagname="label"/>
                            <xf:input adjustMaxLength="false" 
                                     id="inp_email" 
                                     placeholder="이메일을 입력해주세요." 
                                     style=""
                                     ref="data:dmp_loginVo.email"
                                     ev:onkeypress="scwin.inp_email_onkeypress"/>
                        </xf:group>
                        
                        <xf:group id="" tagname="li">
                            <w2:textbox class="tit" for="inp_password" id="" label="Password" style="" tagname="label"/>
                            
                            <xf:group class="login_form" id="">
                                <xf:input adjustMaxLength="false" 
                                         id="inp_password" 
                                         placeholder="비밀번호를 입력해주세요." 
                                         style="" 
                                         type="password"
                                         ref="data:dmp_loginVo.password"
                                         ev:onkeypress="scwin.inp_password_onkeypress"/>
                                
                                <w2:anchor class="btn_login_password" 
                                          id="lnk_toggle_password" 
                                          outerDiv="false" 
                                          style=""
                                          ev:onclick="scwin.btn_toggle_password_onclick">
                                    <xf:label><![CDATA[비밀번호 보기]]></xf:label>
                                </w2:anchor>
                            </xf:group>
                            
                            <xf:group class="grp_password" id="">
                                
                                <w2:anchor class="link_password" id="" outerDiv="false" style="">
                                    <xf:label><![CDATA[Forgot password?]]></xf:label>
                                </w2:anchor>
                            </xf:group>
                        </xf:group>
                    </xf:group>
                    
                    <xf:group class="login_btn" id="" style="">
                        <xf:trigger class="btn_login" 
                                   id="btn_login" 
                                   style="" 
                                   type="button"
                                   ev:onclick="scwin.btn_login_onclick">
                            <xf:label><![CDATA[Login]]></xf:label>
                        </xf:trigger>
                    </xf:group>
                    
                    <xf:group class="login_account" id="" style="">
                        <w2:textbox class="" id="" label="New user?" style=""/>
                        <w2:anchor class="link_account" 
                                  id="lnk_create_corporate" 
                                  outerDiv="false" 
                                  style="" 
                                  ev:onclick="scwin.lnk_create_corporate_onclick">
                            <xf:label><![CDATA[Create an account]]></xf:label>
                        </w2:anchor>
                    </xf:group>
                    
                </xf:group>
            </xf:group>
        </xf:group>
    </body>
</html>