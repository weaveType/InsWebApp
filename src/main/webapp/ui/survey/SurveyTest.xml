<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:w2="http://www.inswave.com/websquare" xmlns:xf="http://www.w3.org/2002/xforms">
    <head meta_screenName="weaveType 개발자 유형 검사 진행">
        <w2:type>COMPONENT</w2:type>
        <w2:buildDate />
        <w2:MSA />
        <xf:model>
            <w2:dataCollection baseNode="map">
                <!-- 상태 관리용 DataMap -->
                <w2:dataMap baseNode="map" id="dma_status">
                    <w2:keyInfo>
                        <w2:key id="currentSet" name="현재세트" dataType="number" value="1"></w2:key>
                        <w2:key id="totalSets" name="총세트수" dataType="number" value="1"></w2:key>
                    </w2:keyInfo>
                </w2:dataMap>

                <!-- 질문 목록 -->
                <w2:dataList baseNode="list" repeatNode="map" id="dlt_questions" saveRemovedData="true">
                    <w2:columnInfo>
                        <w2:column id="questionId" name="질문ID" dataType="number"></w2:column>
                        <w2:column id="questionText" name="질문내용" dataType="text"></w2:column>
                        <w2:column id="axis" name="축" dataType="text"></w2:column>
                    </w2:columnInfo>
                </w2:dataList>

                <!-- 제출용 데이터 -->
                <w2:dataMap baseNode="map" id="dma_submit">
                    <w2:keyInfo>
                        <w2:key id="userId" name="사용자ID" dataType="text"></w2:key>
                        <w2:key id="typeId" name="타입ID" dataType="number"></w2:key>
                    </w2:keyInfo>
                    <w2:dataList baseNode="list" repeatNode="map" id="dlt_answers">
                        <w2:columnInfo>
                            <w2:column id="questionId" name="질문ID" dataType="number"></w2:column>
                            <w2:column id="answerValue" name="답변값" dataType="number"></w2:column>
                        </w2:columnInfo>
                    </w2:dataList>
                </w2:dataMap>

                <!-- 결과 데이터 -->
                <w2:dataMap baseNode="map" id="dma_result">
                    <w2:keyInfo>
                        <w2:key id="typeId" name="타입ID" dataType="number"></w2:key>
                        <w2:key id="typeCode" name="타입코드" dataType="text"></w2:key>
                    </w2:keyInfo>
                </w2:dataMap>
            </w2:dataCollection>

            <w2:submission id="sbm_getQuestions" ref="" target="data:json,dlt_questions" action="SV0001Questions"
                method="post" mediatype="application/json" encoding="UTF-8" mode="asynchronous" processMsg=""
                ev:submitdone="scwin.sbm_getQuestions_callback">
            </w2:submission>

            <w2:submission id="sbm_submitSurvey" ref="data:json,dma_submit" target="data:json,dma_result"
                action="SV0001Submit" method="post" mediatype="application/json" encoding="UTF-8" mode="asynchronous" processMsg="결과를 분석중입니다..."
                ev:submitdone="scwin.sbm_submitSurvey_callback">
            </w2:submission>
        </xf:model>
        <w2:layoutInfo />
        <w2:publicInfo method="" />
        <script type="text/javascript"><![CDATA[
            scwin.onpageload = function() {
                console.log("설문조사 진행 페이지 로드됨");
                var param = $p.getParameter();
                if (param && param.typeId) {
                    dma_submit.set("typeId", param.typeId);
                    // ToDo: 실제 사용자 ID 설정 필요
                    dma_submit.set("userId", "tempUser"); 
                }

                // 질문 목록 조회
                $c.sbm.execute(sbm_getQuestions);
            };

            // 질문 목록 조회 콜백
            scwin.sbm_getQuestions_callback = function(e) {
                var questions = e.originalResponse.questions;
                var questionList = [];
                var totalQuestions = 0;

                // 축별로 그룹핑된 질문을 순서대로 펼치기
                ['B_A', 'R_I', 'S_T', 'D_F'].forEach(function(axis) {
                    if (questions[axis]) {
                        questions[axis].forEach(function(q) {
                            questionList.push({
                                questionId: q.questionId,
                                questionText: q.questionText,
                                axis: axis
                            });
                            totalQuestions++;
                        });
                    }
                });

                dlt_questions.setJSON(questionList);
                
                var totalSets = Math.ceil(totalQuestions / 10);
                dma_status.set("totalSets", totalSets);
                
                console.log("총 문항 수:", totalQuestions, "/ 총 세트:", totalSets);

                scwin.displayCurrentSet();
                scwin.updateProgress();
            };

            // 현재 세트의 문제들 표시
            scwin.displayCurrentSet = function() {
                var currentSet = dma_status.get("currentSet");
                var totalQuestions = dlt_questions.getRowCount();
                var startIndex = (currentSet - 1) * 10;
                var endIndex = Math.min(startIndex + 10, totalQuestions);

                var container = document.querySelector('.questions-container');
                if (!container) return;
                container.innerHTML = '';

                for (var i = startIndex; i < endIndex; i++) {
                    var question = dlt_questions.getRowJSON(i);
                    var questionHtml = scwin.createQuestionElement(question, i + 1);
                    container.appendChild(questionHtml);
                }
                scwin.updateSelectedAnswers();
                scwin.checkAllAnswered();
            };

            // 문제 요소 생성
            scwin.createQuestionElement = function(question, questionNumber) {
                var questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                questionDiv.setAttribute('data-question-id', question.questionId);

                var html = '<div class="question-header">' +
                          '<span class="question-number">문항 ' + questionNumber + '</span>' +
                          '</div>' +
                          '<div class="question-text">' + question.questionText + '</div>' +
                          '<div class="answer-options">';

                var options = [
                    { value: 1, label: '전혀 그렇지 않다' }, { value: 2, label: '그렇지 않다' }, 
                    { value: 3, label: '약간 그렇지 않다' }, { value: 4, label: '보통이다' }, 
                    { value: 5, label: '약간 그렇다' }, { value: 6, label: '그렇다' }, { value: 7, label: '매우 그렇다' }
                ];

                for (var j = 0; j < options.length; j++) {
                    var option = options[j];
                    html += '<div class="option-item" onclick="scwin.selectAnswer(' + question.questionId + ', ' + option.value + ')">' +
                           '<div class="option-circle" data-value="' + option.value + '"></div>' +
                           '<span class="option-label">' + option.label + '</span>' +
                           '</div>';
                }

                html += '</div>';
                questionDiv.innerHTML = html;
                return questionDiv;
            };

            // 답변 선택
            scwin.selectAnswer = function(questionId, value) {
                var rowIndex = dlt_answers.getMatchedIndex("questionId", questionId, true);
                if (rowIndex.length > 0) {
                    dlt_answers.setCellData(rowIndex[0], "answerValue", value);
                } else {
                    var newRow = dlt_answers.insertRow();
                    dlt_answers.setCellData(newRow, "questionId", questionId);
                    dlt_answers.setCellData(newRow, "answerValue", value);
                }
                
                scwin.updateSelectedAnswers();
                scwin.checkAllAnswered();
            };

            // 화면에 선택된 답변들 다시 그리기
            scwin.updateSelectedAnswers = function() {
                 for (var i = 0; i < dlt_answers.getRowCount(); i++) {
                    var row = dlt_answers.getRowJSON(i);
                    var questionElement = document.querySelector('[data-question-id="' + row.questionId + '"]');
                    if (questionElement) {
                        var options = questionElement.querySelectorAll('.option-circle');
                        options.forEach(function(option) {
                            option.classList.remove('selected');
                            if (parseInt(option.dataset.value) === row.answerValue) {
                                option.classList.add('selected');
                            }
                        });
                    }
                }
            };

            // 현재 세트의 모든 문제가 답변되었는지 확인
            scwin.checkAllAnswered = function() {
                var currentSet = dma_status.get("currentSet");
                var totalQuestionsInSet = 0;
                var answeredCount = 0;
                var startIndex = (currentSet - 1) * 10;
                var endIndex = Math.min(startIndex + 10, dlt_questions.getRowCount());

                for (var i = startIndex; i < endIndex; i++) {
                    totalQuestionsInSet++;
                    var questionId = dlt_questions.getCellData(i, "questionId");
                    if (dlt_answers.getMatchedIndex("questionId", questionId, true).length > 0) {
                        answeredCount++;
                    }
                }

                var nextBtn = document.getElementById('btn_next');
                if (nextBtn) {
                    if (totalQuestionsInSet === answeredCount) {
                        nextBtn.classList.add('enabled');
                    } else {
                        nextBtn.classList.remove('enabled');
                    }
                }
            };

            // 진행률 업데이트
            scwin.updateProgress = function() {
                var currentSet = dma_status.get("currentSet");
                var totalSets = dma_status.get("totalSets");
                var progress = (currentSet / totalSets) * 100;

                var progressBar = document.querySelector('.progress-fill');
                var progressText = document.querySelector('.progress-text');

                if (progressBar) progressBar.style.width = progress + '%';
                if (progressText) progressText.textContent = currentSet + ' / ' + totalSets + ' 세트';
                
                // 이전/다음 버튼 텍스트 변경
                var nextBtnLabel = (currentSet == totalSets) ? "결과 보기" : "다음";
                btn_next.setLabel(nextBtnLabel);
            };

            // 이전 버튼 클릭
            scwin.btn_prev_onclick = function() {
                var currentSet = dma_status.get("currentSet");
                if (currentSet > 1) {
                    dma_status.set("currentSet", currentSet - 1);
                    scwin.displayCurrentSet();
                    scwin.updateProgress();
                }
            };

            // 다음 버튼 클릭
            scwin.btn_next_onclick = function() {
                if (!document.getElementById('btn_next').classList.contains('enabled')) {
                    alert("모든 문항에 답변해주세요.");
                    return;
                }

                var currentSet = dma_status.get("currentSet");
                var totalSets = dma_status.get("totalSets");

                if (currentSet < totalSets) {
                    dma_status.set("currentSet", currentSet + 1);
                    scwin.displayCurrentSet();
                    scwin.updateProgress();
                } else {
                    scwin.completeSurvey();
                }
            };

            // 설문 완료 처리 (서버 제출)
            scwin.completeSurvey = function() {
                console.log("설문조사 완료, 서버로 제출합니다.");
                console.log(dma_submit.getAllJSON());
                $c.sbm.execute(sbm_submitSurvey);
            };

            // 설문 제출 콜백
            scwin.sbm_submitSurvey_callback = function(e) {
                console.log("설문 제출 성공:", e.originalResponse);
                var result = dma_result.getAllJSON();
                alert("유형 분석이 완료되었습니다. 결과를 확인해보세요.");
                $p.url({ "url": "SurveyResult.xml", "data": { "typeId": result.typeId } });
            };

        ]]></script>
        
        <style type="text/css"><![CDATA[
            /* 스타일은 기존과 동일하게 유지 */
            .main-container {
                background-color: #f8f9fa;
                min-height: 100vh;
                font-family: "Malgun Gothic", "맑은 고딕", sans-serif;
                display: flex;
                flex-direction: column;
            }
            
            .header {
                width: 100%;
                height: 70px;
                background-color: #ffffff;
                border-bottom: 1px solid #e0e0e0;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            
            .header-logo {
                height: 40px;
                width: auto;
            }
            
            .progress-container {
                width: 100%;
                background-color: white;
                padding: 20px;
                border-bottom: 1px solid #e0e0e0;
            }
            
            .progress-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 16px;
                max-width: 800px;
                margin-left: auto;
                margin-right: auto;
            }
            
            .progress-title {
                font-size: 18px;
                font-weight: 600;
                color: #333;
            }
            
            .progress-text {
                font-size: 14px;
                color: #666;
            }
            
            .progress-bar {
                width: 100%;
                height: 8px;
                background-color: #e9ecef;
                border-radius: 4px;
                overflow: hidden;
                max-width: 800px;
                margin: 0 auto;
            }
            
            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #007bff, #0056b3);
                border-radius: 4px;
                transition: width 0.3s ease;
                width: 0%; /* 초기값 0% */
            }
            
            .content-area {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 40px 20px;
                max-width: 800px;
                margin: 0 auto;
                width: 100%;
            }
            
            .survey-header {
                text-align: center;
                margin-bottom: 40px;
            }
            
            .survey-title {
                font-size: 28px;
                font-weight: bold;
                color: #333;
                margin-bottom: 12px;
            }
            
            .survey-description {
                font-size: 16px;
                color: #666;
                line-height: 1.5;
            }
            
            .questions-container {
                width: 100%;
                margin-bottom: 40px;
            }
            
            .question-item {
                background: white;
                border-radius: 12px;
                padding: 24px;
                margin-bottom: 24px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                transition: all 0.3s ease;
            }
            
            .question-item:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            }
            
            .question-header {
                margin-bottom: 16px;
            }
            
            .question-number {
                display: inline-block;
                background: linear-gradient(45deg, #007bff, #0056b3);
                color: white;
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
            }
            
            .question-text {
                font-size: 18px;
                font-weight: 500;
                color: #333;
                margin-bottom: 20px;
                line-height: 1.6;
            }
            
            .answer-options {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .option-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px 16px;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s ease;
                border: 2px solid transparent;
            }
            
            .option-item:hover {
                background-color: #f0f8ff;
                border-color: #cce7ff;
            }
            
            .option-circle {
                width: 20px;
                height: 20px;
                border: 2px solid #ddd;
                border-radius: 50%;
                position: relative;
                transition: all 0.2s ease;
                flex-shrink: 0;
            }
            
            .option-circle.selected {
                border-color: #007bff;
                background-color: #007bff;
            }
            
            .option-circle.selected::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 8px;
                height: 8px;
                background-color: white;
                border-radius: 50%;
            }
            
            .option-label {
                font-size: 15px;
                color: #333;
                font-weight: 500;
            }
            
            .navigation-area {
                display: flex;
                justify-content: space-between;
                width: 100%;
                gap: 20px;
            }
            
            .btn-nav {
                padding: 16px 32px;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                border: none;
                min-width: 120px;
            }
            
            .btn-prev {
                background-color: #6c757d;
                color: white;
            }
            
            .btn-prev:hover {
                background-color: #5a6268;
            }
            
            .btn-prev:disabled {
                background-color: #e9ecef;
                color: #6c757d;
                cursor: not-allowed;
            }
            
            .btn-next {
                background-color: #e9ecef;
                color: #6c757d;
                cursor: not-allowed;
            }
            
            .btn-next.enabled {
                background-color: #007bff;
                color: white;
                cursor: pointer;
            }
            
            .btn-next.enabled:hover {
                background-color: #0056b3;
            }
            
            .instruction-box {
                background: linear-gradient(135deg, #e3f2fd, #bbdefb);
                border: 1px solid #2196f3;
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 30px;
                text-align: center;
            }
            
            .instruction-text {
                font-size: 16px;
                color: #1976d2;
                font-weight: 500;
                margin: 0;
            }
        ]]></style>
    </head>
    
    <body ev:onpageload="scwin.onpageload">
        <xf:group class="main-container">
            <xf:group class="header">
                <xf:image src="/InsWebApp/images/ws5/weaveTypeLogo.png" class="header-logo"></xf:image>
            </xf:group>
            
            <xf:group class="progress-container">
                <xf:group class="progress-header">
                    <w2:textbox class="progress-title" label="개발자 유형 검사 진행중" tagname="div"></w2:textbox>
                    <w2:textbox class="progress-text" ref="data:dma_status.currentSet" tagname="div"></w2:textbox>
                </xf:group>
                <xf:group class="progress-bar">
                    <xf:group class="progress-fill"></xf:group>
                </xf:group>
            </xf:group>
            
            <xf:group class="content-area">
                <xf:group class="survey-header">
                    <w2:textbox class="survey-title" label="다음 문항들을 읽고 해당하는 정도를 선택해주세요" tagname="h2"></w2:textbox>
                    <w2:textbox class="survey-description" label="정답은 없습니다. 평소 자신의 모습과 가장 가까운 답변을 선택해주세요." tagname="p"></w2:textbox>
                </xf:group>
                
                <xf:group class="instruction-box">
                    <w2:textbox class="instruction-text" label="📝 모든 문항에 응답해야 다음 단계로 진행할 수 있습니다" tagname="p"></w2:textbox>
                </xf:group>
                
                <xf:group class="questions-container">
                    <!-- 문제들이 동적으로 생성됨 -->
                </xf:group>
                
                <xf:group class="navigation-area">
                    <xf:trigger class="btn-nav btn-prev" ev:onclick="scwin.btn_prev_onclick">
                        <xf:label>이전</xf:label>
                    </xf:trigger>
                    
                    <xf:trigger class="btn-nav btn-next" id="btn_next" ev:onclick="scwin.btn_next_onclick">
                        <xf:label>다음</xf:label>
                    </xf:trigger>
                </xf:group>
            </xf:group>
        </xf:group>
    </body>
</html>
