<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.demo.proworks.domain.survey">

    <!-- 활성화된 설문 질문 목록 조회 -->
    <select id="selectActiveQuestions" resultType="com.demo.proworks.domain.survey.vo.SurveyQuestionVo">
        SELECT 
            question_id AS questionId,
            response_id AS responseId,
            axis,
            question_text AS questionText,
            options,
            is_active AS isActive
        FROM survey_questions
        WHERE is_active = 1
        ORDER BY axis, question_id
    </select>
    
    <!-- 설문 응답 저장 -->
    <insert id="insertSurveyResponse" parameterType="com.demo.proworks.domain.survey.vo.SurveyResponseVo">
        <!-- response_id를 미리 생성 -->
        <selectKey keyProperty="responseId" resultType="Long" order="BEFORE">
            SELECT COALESCE(MAX(response_id), 0) + 1 FROM survey_responses
        </selectKey>
        
        INSERT INTO survey_responses (
            response_id,
            type_id,
            responses,
            create_at,
            update_at
        ) VALUES (
            #{responseId},
            #{typeId},
            #{responses},
            NOW(),
            NOW()
        )
    </insert>
    
    <!-- 설문 응답의 type_id 업데이트 -->
    <update id="updateSurveyResponseTypeId" parameterType="com.demo.proworks.domain.survey.vo.SurveyResponseVo">
        UPDATE survey_responses 
        SET type_id = #{typeId},
            update_at = NOW()
        WHERE response_id = #{responseId}
    </update>
    
    <!-- 사용자의 최신 설문 응답 조회 -->
    <select id="selectLatestResponse" parameterType="Long" resultType="com.demo.proworks.domain.survey.vo.SurveyResponseVo">
        SELECT 
            response_id AS responseId,
            type_id AS typeId,
            responses,
            create_at AS createAt,
            update_at AS updateAt
        FROM survey_responses
        WHERE type_id = #{typeId}
        ORDER BY create_at DESC
        LIMIT 1
    </select>
    
    <!-- MBTI 타입 정보 저장/업데이트 -->
    <update id="upsertMbtiType" parameterType="com.demo.proworks.domain.survey.vo.MbtiCalculationResultVo">
        INSERT INTO users_mbti_types (
            type_code,
            A_Bscore,
            R_Iscore,
            S_Tscore,
            D_Fscore,
            analyed_at,
            user_id,
            is_mbti_checked
        ) VALUES (
            #{typeCode},
            #{aBScore},
            #{rIScore},
            #{sTScore},
            #{dFScore},
            NOW(),
            #{userId},
            1
        )
        ON DUPLICATE KEY UPDATE
            type_code = VALUES(type_code),
            A_Bscore = VALUES(A_Bscore),
            R_Iscore = VALUES(R_Iscore),
            S_Tscore = VALUES(S_Tscore),
            D_Fscore = VALUES(D_Fscore),
            analyed_at = NOW(),
            is_mbti_checked = 1
    </update>
    
    <!-- 사용자의 MBTI 타입 조회 -->
    <select id="selectMbtiType" parameterType="Long" resultType="com.demo.proworks.domain.survey.vo.MbtiCalculationResultVo">
        SELECT 
            type_id AS typeId,
            type_code AS typeCode,
            A_Bscore AS aBScore,
            R_Iscore AS rIScore,
            S_Tscore AS sTScore,
            D_Fscore AS dFScore,
            user_id AS userId
        FROM users_mbti_types
        WHERE user_id = #{userId}
        ORDER BY analyed_at DESC
        LIMIT 1
    </select>
    
    <!-- 코드 분석 결과로 MBTI 점수 조회 -->
    <select id="selectCodeAnalysisScores" parameterType="Long" resultType="hashmap">
        SELECT 
            COALESCE(development_style_score, 0) AS development_style_score,
            COALESCE(collaboration_score, 0) AS collaboration_score,
            COALESCE(confidence_score, 0.0) AS confidence_score
        FROM code_analyses
        WHERE type_id = #{typeId}
        ORDER BY created_at DESC
        LIMIT 1
    </select>
    
</mapper>
